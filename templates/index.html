<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äººå‘˜åœ¨å²—è¡Œä¸ºè¯†åˆ«ä¸å®æ—¶å‘Šè­¦ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script id="app-config" type="application/json">
        {{ {'statusIntervalMs': status_interval_ms | default(1000) | int} | tojson }}
    </script>
</head>

<body>
    <div class="container">
        <!-- é¡µé¢å¤´éƒ¨ -->
        <header class="header">
            <h1>äººå‘˜åœ¨å²—è¡Œä¸ºè¯†åˆ«ä¸å®æ—¶å‘Šè­¦ç³»ç»Ÿ</h1>
            <p class="subtitle">åŸºäºYOLOv8æ·±åº¦å­¦ä¹ çš„æ™ºèƒ½ç›‘æ§ç³»ç»Ÿ</p>
        </header>

        <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
        <main class="main-content">
            <!-- è§†é¢‘æ˜¾ç¤ºåŒºåŸŸ -->
            <div class="video-section">
                <div class="video-container">
                    <img id="video-stream" src="{{ url_for('video_feed') }}" alt="å®æ—¶è§†é¢‘æµ" class="video-frame">

                    <!-- è§†é¢‘åŠ è½½æç¤º -->
                    <div id="loading-overlay" class="loading-overlay">
                        <div class="loading-spinner"></div>
                        <p>æ­£åœ¨åŠ è½½è§†é¢‘æµ...</p>
                    </div>
                </div>

                <!-- è§†é¢‘æ§åˆ¶æŒ‰é’®ï¼ˆé¢„ç•™ï¼‰ -->
                <div class="video-controls">
                    <button id="refresh-btn" class="control-btn">
                        ğŸ”„ åˆ·æ–°è§†é¢‘
                    </button>
                    <button id="fullscreen-btn" class="control-btn">
                        ğŸ“º å…¨å±æ˜¾ç¤º
                    </button>
                    <button id="pause-btn" class="control-btn">
                        â¸ æš‚åœæ£€æµ‹
                    </button>
                    <button id="stop-btn" class="control-btn danger">
                        â¹ åœæ­¢è¿è¡Œ
                    </button>
                </div>
            </div>

            <!-- çŠ¶æ€ä¿¡æ¯é¢æ¿ -->
            <div class="info-panel">
                <!-- å®æ—¶çŠ¶æ€ -->
                <div class="status-card">
                    <h3>å®æ—¶çŠ¶æ€</h3>
                    <div class="status-display">
                        <div id="current-status" class="status-text">ç³»ç»Ÿåˆå§‹åŒ–ä¸­...</div>
                        <div id="status-indicator" class="status-indicator unknown"></div>
                    </div>
                    <div class="status-time">
                        æœ€åæ›´æ–°ï¼š<span id="last-update">--</span>
                    </div>
                    <div id="continuous-warning" class="continuous-warning hidden">
                        <span class="warning-icon">âš ï¸</span>
                        <span>å·²è¿ç»­å·¥ä½œ <strong id="continuous-duration">--</strong>ï¼Œè¯·æ³¨æ„ä¼‘æ¯</span>
                    </div>
                </div>

                <!-- ç»Ÿè®¡ä¿¡æ¯ -->
                <div class="stats-card">
                    <h3>ä»Šæ—¥ç»Ÿè®¡</h3>
                    <div id="work-hours-tag" class="work-hours-tag">ç»Ÿè®¡ä¸­ï¼ˆå·¥ä½œæ—¶æ®µï¼‰</div>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value" id="total-time">00:00:00</div>
                            <div class="stat-label">æ€»ç›‘æ§æ—¶é•¿</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="on-duty-time">00:00:00</div>
                            <div class="stat-label">åœ¨å²—æ—¶é•¿</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="off-duty-time">00:00:00</div>
                            <div class="stat-label">ç¦»å²—ç´¯è®¡æ—¶é•¿</div>
                        </div>
                    </div>
                </div>

                <!-- ç³»ç»Ÿä¿¡æ¯ -->
                <div class="system-card">
                    <h3>ç³»ç»Ÿä¿¡æ¯</h3>
                    <div class="system-info">
                        <div class="info-row">
                            <span class="info-label">æ£€æµ‹æ¨¡å‹ï¼š</span>
                            <span class="info-value">YOLOv8s</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">è§†é¢‘åˆ†è¾¨ç‡ï¼š</span>
                            <span class="info-value" id="resolution">640x480</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">å¸§ç‡ï¼š</span>
                            <span class="info-value" id="fps">-- FPS</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">ç³»ç»ŸçŠ¶æ€ï¼š</span>
                            <span class="info-value status-online" id="system-status">è¿è¡Œä¸­</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">æ ‡å‡†æ—¶é—´ï¼š</span>
                            <span class="info-value" id="server-time">--</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">æ—¶é—´åŒæ­¥ï¼š</span>
                            <span class="info-value" id="time-source">æœ¬åœ°</span>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- é¡µé¢åº•éƒ¨ -->
        <footer class="footer">
            <p>&copy; 2025 å¤§å­¦ç”Ÿåˆ›æ–°åˆ›ä¸šé¡¹ç›® - äººå‘˜åœ¨å²—è¡Œä¸ºè¯†åˆ«ç³»ç»Ÿ</p>
            <p>æŠ€æœ¯æ ˆï¼šYOLOv8 + Flask + OpenCV | å¼€å‘å›¢é˜Ÿï¼šåˆ›æ–°å®éªŒå®¤</p>
        </footer>
    </div>

    <!-- JavaScript -->
    <script>
        // å…¨å±€å˜é‡
        const configEl = document.getElementById('app-config');
        window.APP_CONFIG = configEl ? JSON.parse(configEl.textContent || '{}') : {};
        const statusIntervalMs = window.APP_CONFIG.statusIntervalMs || 1000;

        let statusUpdateInterval;
        let paused = false;

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function () {
            initializeSystem();
            setupEventListeners();
            startStatusUpdates();
        });

        // åˆå§‹åŒ–ç³»ç»Ÿ
        function initializeSystem() {
            console.log('ç³»ç»Ÿåˆå§‹åŒ–ä¸­...');

            // éšè—åŠ è½½æç¤º
            setTimeout(() => {
                const loadingOverlay = document.getElementById('loading-overlay');
                if (loadingOverlay) {
                    loadingOverlay.style.display = 'none';
                }
            }, 2000);
        }

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // åˆ·æ–°è§†é¢‘æŒ‰é’®
            const refreshBtn = document.getElementById('refresh-btn');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', refreshVideo);
            }

            // å…¨å±æŒ‰é’®
            const fullscreenBtn = document.getElementById('fullscreen-btn');
            if (fullscreenBtn) {
                fullscreenBtn.addEventListener('click', toggleFullscreen);
            }

            // æš‚åœæŒ‰é’®
            const pauseBtn = document.getElementById('pause-btn');
            if (pauseBtn) {
                pauseBtn.addEventListener('click', togglePause);
            }

            const stopBtn = document.getElementById('stop-btn');
            if (stopBtn) {
                stopBtn.addEventListener('click', shutdownSystem);
            }

            // è§†é¢‘æµé”™è¯¯å¤„ç†
            const videoStream = document.getElementById('video-stream');
            if (videoStream) {
                videoStream.addEventListener('error', handleVideoError);
                videoStream.addEventListener('load', handleVideoLoad);
            }
        }

        // å¼€å§‹çŠ¶æ€æ›´æ–°
        function startStatusUpdates() {
            updateStatus(); // ç«‹å³æ›´æ–°ä¸€æ¬¡
            statusUpdateInterval = setInterval(updateStatus, statusIntervalMs);
        }

        // æ›´æ–°çŠ¶æ€ä¿¡æ¯
        async function updateStatus() {
            try {
                const response = await fetch('/status');
                const data = await response.json();

                // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                paused = Boolean(data.paused);
                updateStatusDisplay(data.status);
                updatePauseButton();
                updateLastUpdateTime();
                updateRunningTime(data.total_seconds);
                updateOnDutyTime(data.on_duty_seconds);
                updateOffDutyTime(data.off_duty_seconds);
                updateWorkHoursTag(Boolean(data.work_hours_active));
                updateContinuousWarning(data.continuous_warning);
                updateServerTime(data.server_time);

            } catch (error) {
                console.error('çŠ¶æ€æ›´æ–°å¤±è´¥:', error);
                updateStatusDisplay('ç³»ç»Ÿè¿æ¥å¼‚å¸¸');
            }
        }

        function updateOnDutyTime(seconds) {
            const onDutyElement = document.getElementById('on-duty-time');
            if (!onDutyElement) return;
            const millis = Math.max(0, Number(seconds) || 0) * 1000;
            onDutyElement.textContent = formatDuration(millis);
        }

        function updateOffDutyTime(seconds) {
            const offDutyElement = document.getElementById('off-duty-time');
            if (!offDutyElement) return;
            const millis = Math.max(0, Number(seconds) || 0) * 1000;
            offDutyElement.textContent = formatDuration(millis);
        }

        function updatePauseButton() {
            const pauseBtn = document.getElementById('pause-btn');
            if (!pauseBtn) return;

            if (paused) {
                pauseBtn.textContent = 'â–¶ï¸ æ¢å¤æ£€æµ‹';
            } else {
                pauseBtn.textContent = 'â¸ æš‚åœæ£€æµ‹';
            }
        }

        function updateWorkHoursTag(isActive) {
            const tag = document.getElementById('work-hours-tag');
            if (!tag) return;
            if (isActive) {
                tag.textContent = 'ç»Ÿè®¡ä¸­ï¼ˆå·¥ä½œæ—¶æ®µï¼‰';
                tag.classList.remove('off-hours');
            } else {
                tag.textContent = 'å½“å‰éå·¥ä½œæ—¶æ®µï¼Œæš‚åœç´¯è®¡';
                tag.classList.add('off-hours');
            }
        }

        function updateContinuousWarning(warning) {
            const warningBox = document.getElementById('continuous-warning');
            const durationEl = document.getElementById('continuous-duration');
            if (!warningBox || !durationEl) return;
            if (!warning || !warning.threshold) {
                warningBox.classList.add('hidden');
                return;
            }
            const seconds = Math.max(0, Number(warning.continuous_seconds) || 0);
            durationEl.textContent = formatDuration(seconds * 1000);
            if (warning.active) {
                warningBox.classList.remove('hidden');
            } else {
                warningBox.classList.add('hidden');
            }
        }

        function updateServerTime(serverTime) {
            const timeEl = document.getElementById('server-time');
            const sourceEl = document.getElementById('time-source');
            if (!timeEl || !sourceEl || !serverTime) return;
            const epoch = Number(serverTime.epoch) || Date.now() / 1000;
            const date = new Date(epoch * 1000);
            timeEl.textContent = formatDateTime(date);
            const sourceLabel = serverTime.source === 'network' ? 'ç½‘ç»œå¯¹æ—¶' : 'æœ¬åœ°æ—¶é—´';
            let syncInfo = sourceLabel;
            if (serverTime.last_sync) {
                const lastSyncDate = new Date(Number(serverTime.last_sync) * 1000);
                syncInfo += `ï¼ˆä¸Šæ¬¡åŒæ­¥ ${formatTime(lastSyncDate)}ï¼‰`;
            }
            sourceEl.textContent = syncInfo;
        }

        async function togglePause() {
            try {
                const response = await fetch('/api/pause', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ paused: !paused })
                });
                const data = await response.json();
                paused = Boolean(data.paused);
                updatePauseButton();
            } catch (error) {
                console.error('åˆ‡æ¢æš‚åœçŠ¶æ€å¤±è´¥:', error);
            }
        }

        async function shutdownSystem() {
            if (!confirm('ç¡®å®šè¦åœæ­¢ç³»ç»Ÿè¿è¡Œå—ï¼Ÿ')) {
                return;
            }
            const stopBtn = document.getElementById('stop-btn');
            if (stopBtn) {
                stopBtn.disabled = true;
                stopBtn.textContent = 'â³ å·²åœæ­¢...';
            }
            try {
                const response = await fetch('/api/shutdown', {
                    method: 'POST'
                });
                if (!response.ok) {
                    throw new Error('è¯·æ±‚å¤±è´¥');
                }
            } catch (error) {
                alert('åœæ­¢å¤±è´¥ï¼Œè¯·æŸ¥çœ‹åå°æ—¥å¿—');
                console.error('åœæ­¢å¤±è´¥:', error);
            }
        }

        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStatusDisplay(status) {
            const statusElement = document.getElementById('current-status');
            const indicatorElement = document.getElementById('status-indicator');

            if (statusElement) {
                statusElement.textContent = status;
            }

            if (indicatorElement) {
                // ç§»é™¤æ‰€æœ‰çŠ¶æ€ç±»
                indicatorElement.className = 'status-indicator';

                // æ ¹æ®çŠ¶æ€æ·»åŠ ç›¸åº”çš„ç±»
                if (status.includes('åœ¨å²—')) {
                    indicatorElement.classList.add('on-duty');
                } else if (status.includes('ç¦»å²—')) {
                    indicatorElement.classList.add('off-duty');
                } else {
                    indicatorElement.classList.add('unknown');
                }
            }
        }

        // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´
        function updateLastUpdateTime() {
            const lastUpdateElement = document.getElementById('last-update');
            if (lastUpdateElement) {
                const now = new Date();
                lastUpdateElement.textContent = now.toLocaleTimeString();
            }
        }

        // æ›´æ–°è¿è¡Œæ—¶é—´
        function updateRunningTime(seconds) {
            const totalTimeElement = document.getElementById('total-time');
            if (!totalTimeElement) return;
            const millis = Math.max(0, Number(seconds) || 0) * 1000;
            totalTimeElement.textContent = formatDuration(millis);
        }

        // æ ¼å¼åŒ–æ—¶é•¿
        function formatDuration(milliseconds) {
            const seconds = Math.floor(milliseconds / 1000);
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;

            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function formatDateTime(date) {
            const y = date.getFullYear();
            const m = (date.getMonth() + 1).toString().padStart(2, '0');
            const d = date.getDate().toString().padStart(2, '0');
            return `${y}-${m}-${d} ${formatTime(date)}`;
        }

        function formatTime(date) {
            const hh = date.getHours().toString().padStart(2, '0');
            const mm = date.getMinutes().toString().padStart(2, '0');
            const ss = date.getSeconds().toString().padStart(2, '0');
            return `${hh}:${mm}:${ss}`;
        }

        // åˆ·æ–°è§†é¢‘
        function refreshVideo() {
            const videoStream = document.getElementById('video-stream');
            if (videoStream) {
                const currentSrc = videoStream.src;
                videoStream.src = '';
                setTimeout(() => {
                    videoStream.src = currentSrc + '?t=' + new Date().getTime();
                }, 100);
            }
        }

        // åˆ‡æ¢å…¨å±
        function toggleFullscreen() {
            const videoContainer = document.querySelector('.video-container');

            if (!document.fullscreenElement) {
                videoContainer.requestFullscreen().catch(err => {
                    console.error('æ— æ³•è¿›å…¥å…¨å±æ¨¡å¼:', err);
                });
            } else {
                document.exitFullscreen();
            }
        }

        // å¤„ç†è§†é¢‘é”™è¯¯
        function handleVideoError(event) {
            console.error('è§†é¢‘æµé”™è¯¯:', event);
            const loadingOverlay = document.getElementById('loading-overlay');
            if (loadingOverlay) {
                loadingOverlay.innerHTML = '<p style="color: #ff6b6b;">è§†é¢‘æµè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç³»ç»ŸçŠ¶æ€</p>';
                loadingOverlay.style.display = 'flex';
            }
        }

        // å¤„ç†è§†é¢‘åŠ è½½
        function handleVideoLoad(event) {
            console.log('è§†é¢‘æµåŠ è½½æˆåŠŸ');
            const loadingOverlay = document.getElementById('loading-overlay');
            if (loadingOverlay) {
                loadingOverlay.style.display = 'none';
            }
        }

        // é¡µé¢å¸è½½æ—¶æ¸…ç†
        window.addEventListener('beforeunload', function () {
            if (statusUpdateInterval) {
                clearInterval(statusUpdateInterval);
            }
        });

        // é¢„ç•™çš„æ‰©å±•åŠŸèƒ½
        function showAnalytics() {
            // TODO: æ˜¾ç¤ºè¯¦ç»†åˆ†ææ•°æ®
            alert('æ•°æ®åˆ†æåŠŸèƒ½å¼€å‘ä¸­...');
        }

        function exportReport() {
            // TODO: å¯¼å‡ºæŠ¥å‘Š
            alert('æŠ¥å‘Šå¯¼å‡ºåŠŸèƒ½å¼€å‘ä¸­...');
        }

        function configureAlerts() {
            // TODO: é…ç½®å‘Šè­¦è®¾ç½®
            alert('å‘Šè­¦é…ç½®åŠŸèƒ½å¼€å‘ä¸­...');
        }
    </script>
</body>

</html>