<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äººå‘˜åœ¨å²—è¡Œä¸ºè¯†åˆ«ä¸å®æ—¶å‘Šè­¦ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
    <div class="container">
        <!-- é¡µé¢å¤´éƒ¨ -->
        <header class="header">
            <h1>äººå‘˜åœ¨å²—è¡Œä¸ºè¯†åˆ«ä¸å®æ—¶å‘Šè­¦ç³»ç»Ÿ</h1>
            <p class="subtitle">åŸºäºYOLOv8æ·±åº¦å­¦ä¹ çš„æ™ºèƒ½ç›‘æ§ç³»ç»Ÿ</p>
        </header>

        <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
        <main class="main-content">
            <!-- è§†é¢‘æ˜¾ç¤ºåŒºåŸŸ -->
            <div class="video-section">
                <div class="video-container">
                    <img id="video-stream" src="{{ url_for('video_feed') }}" alt="å®æ—¶è§†é¢‘æµ" class="video-frame">

                    <!-- è§†é¢‘åŠ è½½æç¤º -->
                    <div id="loading-overlay" class="loading-overlay">
                        <div class="loading-spinner"></div>
                        <p>æ­£åœ¨åŠ è½½è§†é¢‘æµ...</p>
                    </div>
                </div>

                <!-- è§†é¢‘æ§åˆ¶æŒ‰é’®ï¼ˆé¢„ç•™ï¼‰ -->
                <div class="video-controls">
                    <button id="refresh-btn" class="control-btn">
                        ğŸ”„ åˆ·æ–°è§†é¢‘
                    </button>
                    <button id="fullscreen-btn" class="control-btn">
                        ğŸ“º å…¨å±æ˜¾ç¤º
                    </button>
                </div>
            </div>

            <!-- çŠ¶æ€ä¿¡æ¯é¢æ¿ -->
            <div class="info-panel">
                <!-- å®æ—¶çŠ¶æ€ -->
                <div class="status-card">
                    <h3>å®æ—¶çŠ¶æ€</h3>
                    <div class="status-display">
                        <div id="current-status" class="status-text">ç³»ç»Ÿåˆå§‹åŒ–ä¸­...</div>
                        <div id="status-indicator" class="status-indicator unknown"></div>
                    </div>
                    <div class="status-time">
                        æœ€åæ›´æ–°ï¼š<span id="last-update">--</span>
                    </div>
                </div>

                <!-- ç»Ÿè®¡ä¿¡æ¯ -->
                <div class="stats-card">
                    <h3>ä»Šæ—¥ç»Ÿè®¡</h3>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value" id="total-time">00:00:00</div>
                            <div class="stat-label">æ€»ç›‘æ§æ—¶é•¿</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="on-duty-time">00:00:00</div>
                            <div class="stat-label">åœ¨å²—æ—¶é•¿</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="alert-count">0</div>
                            <div class="stat-label">å‘Šè­¦æ¬¡æ•°</div>
                        </div>
                    </div>
                </div>

                <!-- ç³»ç»Ÿä¿¡æ¯ -->
                <div class="system-card">
                    <h3>ç³»ç»Ÿä¿¡æ¯</h3>
                    <div class="system-info">
                        <div class="info-row">
                            <span class="info-label">æ£€æµ‹æ¨¡å‹ï¼š</span>
                            <span class="info-value">YOLOv8s</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">è§†é¢‘åˆ†è¾¨ç‡ï¼š</span>
                            <span class="info-value" id="resolution">640x480</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">å¸§ç‡ï¼š</span>
                            <span class="info-value" id="fps">-- FPS</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">ç³»ç»ŸçŠ¶æ€ï¼š</span>
                            <span class="info-value status-online" id="system-status">è¿è¡Œä¸­</span>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- é¡µé¢åº•éƒ¨ -->
        <footer class="footer">
            <p>&copy; 2025 å¤§å­¦ç”Ÿåˆ›æ–°åˆ›ä¸šé¡¹ç›® - äººå‘˜åœ¨å²—è¡Œä¸ºè¯†åˆ«ç³»ç»Ÿ</p>
            <p>æŠ€æœ¯æ ˆï¼šYOLOv8 + Flask + OpenCV | å¼€å‘å›¢é˜Ÿï¼šåˆ›æ–°å®éªŒå®¤</p>
        </footer>
    </div>

    <!-- JavaScript -->
    <script>
        // å…¨å±€å˜é‡
        let statusUpdateInterval;
        let startTime = new Date();

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function () {
            initializeSystem();
            setupEventListeners();
            startStatusUpdates();
        });

        // åˆå§‹åŒ–ç³»ç»Ÿ
        function initializeSystem() {
            console.log('ç³»ç»Ÿåˆå§‹åŒ–ä¸­...');

            // éšè—åŠ è½½æç¤º
            setTimeout(() => {
                const loadingOverlay = document.getElementById('loading-overlay');
                if (loadingOverlay) {
                    loadingOverlay.style.display = 'none';
                }
            }, 2000);
        }

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // åˆ·æ–°è§†é¢‘æŒ‰é’®
            const refreshBtn = document.getElementById('refresh-btn');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', refreshVideo);
            }

            // å…¨å±æŒ‰é’®
            const fullscreenBtn = document.getElementById('fullscreen-btn');
            if (fullscreenBtn) {
                fullscreenBtn.addEventListener('click', toggleFullscreen);
            }

            // è§†é¢‘æµé”™è¯¯å¤„ç†
            const videoStream = document.getElementById('video-stream');
            if (videoStream) {
                videoStream.addEventListener('error', handleVideoError);
                videoStream.addEventListener('load', handleVideoLoad);
            }
        }

        // å¼€å§‹çŠ¶æ€æ›´æ–°
        function startStatusUpdates() {
            updateStatus(); // ç«‹å³æ›´æ–°ä¸€æ¬¡
            statusUpdateInterval = setInterval(updateStatus, 1000); // æ¯ç§’æ›´æ–°
        }

        // æ›´æ–°çŠ¶æ€ä¿¡æ¯
        async function updateStatus() {
            try {
                const response = await fetch('/status');
                const data = await response.json();

                // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                updateStatusDisplay(data.status);
                updateLastUpdateTime();
                updateRunningTime();

            } catch (error) {
                console.error('çŠ¶æ€æ›´æ–°å¤±è´¥:', error);
                updateStatusDisplay('ç³»ç»Ÿè¿æ¥å¼‚å¸¸');
            }
        }

        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStatusDisplay(status) {
            const statusElement = document.getElementById('current-status');
            const indicatorElement = document.getElementById('status-indicator');

            if (statusElement) {
                statusElement.textContent = status;
            }

            if (indicatorElement) {
                // ç§»é™¤æ‰€æœ‰çŠ¶æ€ç±»
                indicatorElement.className = 'status-indicator';

                // æ ¹æ®çŠ¶æ€æ·»åŠ ç›¸åº”çš„ç±»
                if (status.includes('åœ¨å²—')) {
                    indicatorElement.classList.add('on-duty');
                } else if (status.includes('ç¦»å²—')) {
                    indicatorElement.classList.add('off-duty');
                } else {
                    indicatorElement.classList.add('unknown');
                }
            }
        }

        // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´
        function updateLastUpdateTime() {
            const lastUpdateElement = document.getElementById('last-update');
            if (lastUpdateElement) {
                const now = new Date();
                lastUpdateElement.textContent = now.toLocaleTimeString();
            }
        }

        // æ›´æ–°è¿è¡Œæ—¶é—´
        function updateRunningTime() {
            const totalTimeElement = document.getElementById('total-time');
            if (totalTimeElement) {
                const now = new Date();
                const diff = now - startTime;
                totalTimeElement.textContent = formatDuration(diff);
            }
        }

        // æ ¼å¼åŒ–æ—¶é•¿
        function formatDuration(milliseconds) {
            const seconds = Math.floor(milliseconds / 1000);
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;

            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // åˆ·æ–°è§†é¢‘
        function refreshVideo() {
            const videoStream = document.getElementById('video-stream');
            if (videoStream) {
                const currentSrc = videoStream.src;
                videoStream.src = '';
                setTimeout(() => {
                    videoStream.src = currentSrc + '?t=' + new Date().getTime();
                }, 100);
            }
        }

        // åˆ‡æ¢å…¨å±
        function toggleFullscreen() {
            const videoContainer = document.querySelector('.video-container');

            if (!document.fullscreenElement) {
                videoContainer.requestFullscreen().catch(err => {
                    console.error('æ— æ³•è¿›å…¥å…¨å±æ¨¡å¼:', err);
                });
            } else {
                document.exitFullscreen();
            }
        }

        // å¤„ç†è§†é¢‘é”™è¯¯
        function handleVideoError(event) {
            console.error('è§†é¢‘æµé”™è¯¯:', event);
            const loadingOverlay = document.getElementById('loading-overlay');
            if (loadingOverlay) {
                loadingOverlay.innerHTML = '<p style="color: #ff6b6b;">è§†é¢‘æµè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç³»ç»ŸçŠ¶æ€</p>';
                loadingOverlay.style.display = 'flex';
            }
        }

        // å¤„ç†è§†é¢‘åŠ è½½
        function handleVideoLoad(event) {
            console.log('è§†é¢‘æµåŠ è½½æˆåŠŸ');
            const loadingOverlay = document.getElementById('loading-overlay');
            if (loadingOverlay) {
                loadingOverlay.style.display = 'none';
            }
        }

        // é¡µé¢å¸è½½æ—¶æ¸…ç†
        window.addEventListener('beforeunload', function () {
            if (statusUpdateInterval) {
                clearInterval(statusUpdateInterval);
            }
        });

        // é¢„ç•™çš„æ‰©å±•åŠŸèƒ½
        function showAnalytics() {
            // TODO: æ˜¾ç¤ºè¯¦ç»†åˆ†ææ•°æ®
            alert('æ•°æ®åˆ†æåŠŸèƒ½å¼€å‘ä¸­...');
        }

        function exportReport() {
            // TODO: å¯¼å‡ºæŠ¥å‘Š
            alert('æŠ¥å‘Šå¯¼å‡ºåŠŸèƒ½å¼€å‘ä¸­...');
        }

        function configureAlerts() {
            // TODO: é…ç½®å‘Šè­¦è®¾ç½®
            alert('å‘Šè­¦é…ç½®åŠŸèƒ½å¼€å‘ä¸­...');
        }
    </script>
</body>

</html>